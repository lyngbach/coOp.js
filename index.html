<!DOCTYPE html>
<html>
	<head>
	<link rel="stylesheet" href="css/stylesheet.css">
	</head>

	<body>
		<!--<iframe id="editor" class="editor">
			<head></head>
			<body><div>some text</div></body>
		</iframe>-->

		<div contenteditable="true" id="editor" class="editor">
			<p>Second paragraph here</p>
			<p>First line</p>
		</div>

		<button id="editorBold">bold</button>
		<button id="editorItalic">italic</button>
		<button id="editorHeading">heading</button>

		<script src="node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
		<script>
			var socket = io.connect(),
				editor = document.getElementById('editor'),
				userId = 'user_' + new Date().getTime();
			/*var editor = document.getElementById('editor').contentDocument;
			editor.designMode = "On";
			editor.execCommand("insertBrOnReturn", false, "true");*/
			console.log('unique user: ' + userId);
			var paragraphs = {
				index: [
					1,
					0
				],
				data: [
					{ text: 'Second paragraph here', lock: '' },
					{ text: 'First line', lock: '' }
				]
			};

			var findPosition = function (startContainer) {
				var row = 0,
					col = window.getSelection().getRangeAt(0).startOffset,
					parentElement;
				
				if (startContainer.nodeType === 1) {
					parentElement = startContainer.previousSibling;
				} else {
					parentElement = startContainer.parentNode.previousSibling;
				}
								
				// find the current row/paragraph
				while (parentElement.previousSibling !== null) {
					if (parentElement.nodeType !== 3) {
						row += 1;
					}
					
					parentElement = parentElement.previousSibling;						
				}

				return {row: row, col: col }
			};

			var setColorAndLock = function () {
				var paragraph = editor.getElementsByTagName('p');

				// remove users lock/color
				for (var p = 0; p < paragraph.length; p++) {
					paragraph[p].classList.remove('userColor1');
				}

				// looping through data object
				for (var i = 0; i < paragraphs.data.length; i++) {
					if (paragraphs.data[i].lock === userId) {
						paragraphs.data[i].lock = '';
					}
				}
			};

			editor.addEventListener('click', function (event) {
				var paragraph = editor.getElementsByTagName('p'),
					currentPos = findPosition(window.getSelection().getRangeAt(0).startContainer);

				// set color and lock
				setColorAndLock();

				paragraphs.data[currentPos.row].lock = userId;
				window.getSelection().getRangeAt(0).startContainer.parentNode.className = 'userColor1';
			}, false);

			editor.addEventListener('keyup', function (event) {
				var paraPos = window.getSelection().getRangeAt(0).startOffset,
					paragraph = editor.getElementsByTagName('p'),
					currentPos = findPosition(window.getSelection().getRangeAt(0).startContainer);
				

				// set color and lock
				setColorAndLock();

				console.log('writing in paragraph', currentPos.row);
			
				if (event.keyCode !== 13) {
					paragraphs.data[currentPos.row].text = paragraph[currentPos.row].textContent;
					if (window.getSelection().getRangeAt(0).startContainer.parentNode.className !== 'editor') {
						window.getSelection().getRangeAt(0).startContainer.parentNode.className = 'userColor1';
					}
				}

				if (event.keyCode === 13) { // if enter key
					document.execCommand('formatBlock', false, '<p>');
					
					var newPos = findPosition(window.getSelection().getRangeAt(0).startContainer);
					
					console.log('newPos:', newPos);


					//if (window.getSelection().getRangeAt(0).startContainer.previousSibling !== null) {
						
						if (newPos.row === paragraphs.data.length) { // if last line
							console.log('last line');
							paragraphs.data.splice((newPos.row), 0, {text: '', lock: ''});
							paragraphs.index.splice((newPos.row), 0, (paragraphs.data.length));
							window.getSelection().getRangeAt(0).startContainer.previousSibling.classList.remove('userColor1');
						} else {
							console.log('not last line');
							paragraphs.data.splice((newPos.row - 1), 0, {text: '', lock: ''});
							paragraphs.index.splice((newPos.row - 1), 0, (paragraphs.data.length - 1));
						}
						console.log(paragraphs);
					//}

					// prevent the default behaviour of return key pressed
					return false;
			    }

			    socket.emit('sendText', paragraphs);

			    console.log(paragraphs);

			}, false);

			socket.on('msgBroadcast', function (paragraphs) {
				console.log('recieving from broadcast', paragraphs);
				//editor.getElementsByTagName('p');
		    });

			console.log(paragraphs);

			document.getElementById('editorBold').addEventListener('click', function () {
				document.execCommand('bold', false, '');
			}, false);

			document.getElementById('editorItalic').addEventListener('click', function () {
				document.execCommand('italic', false, '');
			}, false);

			document.getElementById('editorHeading').addEventListener('click', function () {
				document.execCommand('formatBlock', false, '<h2>');
			}, false);
			
		</script>
	</body>
</html>

